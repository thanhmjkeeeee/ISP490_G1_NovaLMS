<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: common-head(pageTitle='Đặt lại mật khẩu')}"></head>

<body class="index-page">

<header th:replace="~{fragments/header :: header-fragment(currentPage='login')}"></header>

<main class="main">
  <section class="login-section" style="padding: 100px 0; background-color: #f9f9f9;">
    <div class="container" data-aos="fade-up">
      <div class="row justify-content-center">
        <div class="col-lg-5 col-md-8">
          <div class="card shadow-sm border-0" style="border-radius: 15px;">
            <div class="card-body p-5">

              <div class="text-center mb-4">
                <h3 style="font-weight: 700; color: var(--heading-color);">Đặt Lại Mật Khẩu</h3>
                <p class="text-muted">Vui lòng nhập mật khẩu mới cho tài khoản của bạn</p>
              </div>

              <div id="resetAlert" class="alert d-none"></div>

              <form id="resetPasswordForm">
                <!-- Token lấy từ URL, input ẩn -->
                <input type="hidden" id="token">

                <div class="mb-3">
                  <label for="newPassword" class="form-label">Mật khẩu mới</label>
                  <input type="password" class="form-control" id="newPassword" required minlength="6">
                </div>

                <div class="mb-3">
                  <label for="confirmPassword" class="form-label">Xác nhận mật khẩu</label>
                  <input type="password" class="form-control" id="confirmPassword" required minlength="6">
                </div>

                <button type="submit" class="btn btn-primary w-100 py-2" id="resetBtn" style="border-radius: 50px; font-weight: 600;">
                  Xác nhận thay đổi
                </button>
              </form>

              <div class="text-center mt-4">
                <a th:href="@{/login.html}" class="text-decoration-none">Quay lại đăng nhập</a>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer th:replace="~{fragments/footer :: common-footer}"></footer>
<th:block th:replace="~{fragments/footer :: common-scripts}"></th:block>

<script>
  // 1. Lấy token từ URL (ví dụ: ?token=abc-xyz)
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token');

  if (token) {
    document.getElementById('token').value = token;
  } else {
    document.getElementById('resetAlert').className = 'alert alert-danger';
    document.getElementById('resetAlert').textContent = 'Lỗi: Token không hợp lệ hoặc thiếu token.';
    document.getElementById('resetAlert').classList.remove('d-none');
    document.getElementById('resetBtn').disabled = true;
  }

  // 2. Xử lý Submit
  document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    const tokenVal = document.getElementById('token').value;
    const alertBox = document.getElementById('resetAlert');
    const btn = document.getElementById('resetBtn');

    if (newPassword !== confirmPassword) {
      alertBox.className = 'alert alert-danger';
      alertBox.textContent = 'Mật khẩu xác nhận không khớp!';
      alertBox.classList.remove('d-none');
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Đang xử lý...';

    try {
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          token: tokenVal,
          newPassword: newPassword
        })
      });

      const message = await response.text();

      if (response.ok) {
        alertBox.className = 'alert alert-success';
        alertBox.textContent = 'Đổi mật khẩu thành công! Đang chuyển hướng...';
        alertBox.classList.remove('d-none');

        setTimeout(() => {
          window.location.href = '/login.html';
        }, 2000);
      } else {
        throw new Error(message);
      }
    } catch (error) {
      alertBox.className = 'alert alert-danger';
      alertBox.textContent = error.message || 'Có lỗi xảy ra.';
      alertBox.classList.remove('d-none');
      btn.disabled = false;
      btn.textContent = 'Xác nhận thay đổi';
    }
  });
</script>

</body>
</html>